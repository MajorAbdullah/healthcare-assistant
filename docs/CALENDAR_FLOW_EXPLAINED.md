# üìÖ Calendar Integration & User Flow - Complete Explanation

## üîç Current Setup Overview

### **YES - Same Calendar for Everyone**
All appointments (from both patient and doctor portals) sync to the **SAME Google Calendar**:
- **Calendar Email**: `pinkpantherking20@gmail.com`
- **All 3 doctors** share this calendar
- **All patients** sync their appointments to this calendar
- **Configured via**: Pipedream (MCP - Model Context Protocol)

---

## üèóÔ∏è Architecture Overview

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     HEALTHCARE ASSISTANT SYSTEM                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ  Patient Portal  ‚îÇ              ‚îÇ  Doctor Portal   ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ                  ‚îÇ              ‚îÇ                  ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Book appt     ‚îÇ              ‚îÇ  ‚Ä¢ View schedule ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Sync calendar ‚îÇ              ‚îÇ  ‚Ä¢ Sync appts    ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ           ‚îÇ                                 ‚îÇ                       ‚îÇ
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                       ‚îÇ
‚îÇ                        ‚îÇ                                            ‚îÇ
‚îÇ                        ‚ñº                                            ‚îÇ
‚îÇ           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                ‚îÇ
‚îÇ           ‚îÇ  CalendarSync Module   ‚îÇ                                ‚îÇ
‚îÇ           ‚îÇ  (calendar_sync.py)    ‚îÇ                                ‚îÇ
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                ‚îÇ
‚îÇ                        ‚îÇ                                            ‚îÇ
‚îÇ                        ‚ñº                                            ‚îÇ
‚îÇ           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                ‚îÇ
‚îÇ           ‚îÇ  SmartCalendarAssistant‚îÇ                                ‚îÇ
‚îÇ           ‚îÇ  (calendar_assistant.py)‚îÇ                               ‚îÇ
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                ‚îÇ
‚îÇ                        ‚îÇ                                            ‚îÇ
‚îÇ                        ‚ñº                                            ‚îÇ
‚îÇ           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                ‚îÇ
‚îÇ           ‚îÇ   Pipedream MCP        ‚îÇ                                ‚îÇ
‚îÇ           ‚îÇ   (Model Context       ‚îÇ                                ‚îÇ
‚îÇ           ‚îÇ    Protocol)           ‚îÇ                                ‚îÇ
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                ‚îÇ
‚îÇ                        ‚îÇ                                            ‚îÇ
‚îÇ                        ‚ñº                                            ‚îÇ
‚îÇ           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                ‚îÇ
‚îÇ           ‚îÇ  Google Calendar API   ‚îÇ                                ‚îÇ
‚îÇ           ‚îÇ                        ‚îÇ                                ‚îÇ
‚îÇ           ‚îÇ  pinkpantherking20     ‚îÇ                                ‚îÇ
‚îÇ           ‚îÇ  @gmail.com            ‚îÇ                                ‚îÇ
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìä Database Configuration

### Doctors Table:
```sql
doctor_id | name              | specialty                     | calendar_id
----------|-------------------|-------------------------------|---------------------------
1         | Dr. Sarah Johnson | Neurology - Stroke Specialist | pinkpantherking20@gmail.com
2         | Dr. Michael Chen  | Emergency Medicine            | pinkpantherking20@gmail.com
3         | Dr. Aisha Khan    | Rehabilitation & Recovery     | pinkpantherking20@gmail.com
```

**All doctors share the SAME calendar_id** = `pinkpantherking20@gmail.com`

---

## üîÑ Complete User Flow

### **PATIENT PORTAL FLOW**

#### 1. **Patient Books Appointment**
```
Patient Portal (healthcare_assistant.py)
  ‚Üì
User selects: [2] Book an appointment
  ‚Üì
1. Choose Doctor (Dr. Sarah Johnson)
2. Enter Date (2025-10-29)
3. Select Time (10:00 AM)
4. Enter Reason ("Stroke prevention consultation")
5. Confirm booking
  ‚Üì
AppointmentScheduler.book_appointment()
  ‚Üì
Appointment saved to SQLite database:
  - appointment_id: 11
  - user_id: 5
  - doctor_id: 1
  - appointment_date: 2025-10-29
  - start_time: 10:00:00
  - end_time: 10:30:00
  - status: 'scheduled'
  - reason: "Stroke prevention consultation"
```

#### 2. **Calendar Sync Prompt**
```
System asks: "Would you like to sync to Google Calendar? (Y/n)"
  ‚Üì
If user says YES:
  ‚Üì
CalendarSync.sync_appointment(appointment_id=11)
  ‚Üì
Fetches appointment details from database
  ‚Üì
Formats natural language command:
  "Schedule an event titled 'Appointment: John Doe with Dr. Sarah Johnson'
   on Tuesday, October 29, 2025 from 10:00 AM to 10:30 AM.
   
   Description:
   Patient: John Doe
   Email: john@example.com
   Doctor: Dr. Sarah Johnson (Neurology - Stroke Specialist)
   Reason: Stroke prevention consultation
   
   Appointment ID: 11"
```

#### 3. **Pipedream Integration**
```
SmartCalendarAssistant (calendar_assistant.py)
  ‚Üì
Connects to Pipedream MCP server
  ‚Üì
Sends natural language request via Gemini AI
  ‚Üì
Pipedream processes request through:
  - Authentication (OAuth 2.0)
  - MCP protocol translation
  - Google Calendar API call
  ‚Üì
Creates event on: pinkpantherking20@gmail.com
  ‚Üì
Returns success confirmation
```

#### 4. **Database Update**
```
Update appointments table:
  SET calendar_event_id = 'synced_via_assistant'
  SET notes = notes || '\n[Calendar synced to pinkpantherking20@gmail.com]'
  WHERE appointment_id = 11
  ‚Üì
Patient sees:
  ‚úÖ Appointment synced to Google Calendar!
  üìß Email notification sent
  üìÖ Check your calendar at pinkpantherking20@gmail.com
```

---

### **DOCTOR PORTAL FLOW**

#### 1. **Doctor Views Schedule**
```
Doctor Portal (doctor_portal.py)
  ‚Üì
Login as Dr. Sarah Johnson (ID: 1)
  ‚Üì
Select: [1] View Today's Schedule
  ‚Üì
Queries database:
  SELECT * FROM appointments
  WHERE doctor_id = 1
    AND appointment_date = '2025-10-28'
  ‚Üì
Displays table:
  Time    | Patient   | Contact      | Reason              | Status
  10:00AM | John Doe  | 555-1234     | Stroke prevention   | üü¢ Scheduled
  2:00PM  | Jane Smith| 555-5678     | Follow-up           | üü¢ Scheduled
```

#### 2. **Doctor Syncs Appointments**
```
Doctor selects: [7] Sync to Calendar
  ‚Üì
System finds all upcoming scheduled appointments:
  - Filters: status='scheduled', date >= today
  ‚Üì
Found 5 upcoming appointments
  ‚Üì
Prompt: "Sync these to Google Calendar? (Y/n)"
  ‚Üì
If YES:
  ‚Üì
For each appointment (in parallel or sequence):
  CalendarSync.sync_appointment(appointment_id)
  ‚Üì
  Formats event details
  ‚Üì
  Sends to Pipedream ‚Üí Google Calendar
  ‚Üì
  Updates database with sync status
  ‚Üì
Progress: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 100% (5/5 synced)
  ‚Üì
‚úÖ Successfully synced 5/5 appointments!
```

#### 3. **Doctor Adds Notes**
```
Doctor selects: [4] Add Medical Notes
  ‚Üì
Shows recent appointments (last 7 days)
  ‚Üì
Doctor enters appointment ID: 11
  ‚Üì
Doctor types notes:
  "Patient presented with concerns about stroke prevention.
   Discussed lifestyle modifications:
   - Blood pressure monitoring
   - Regular exercise
   - Mediterranean diet
   
   Prescribed: Low-dose aspirin
   Follow-up: 3 months"
  ‚Üì
Updates database:
  UPDATE appointments
  SET notes = '[entered text]'
  WHERE appointment_id = 11
  ‚Üì
‚úÖ Medical notes saved successfully!
```

---

## üîê Authentication & Configuration

### Pipedream Configuration (.env file):
```env
# Pipedream OAuth Setup
PIPEDREAM_PROJECT_ID=proj_PNsKbWY
PIPEDREAM_ENVIRONMENT=development
PIPEDREAM_CLIENT_ID=Yvd50ERegpRGxMdmqAxQZ5zJmONx82esjU_Sbjn8pNs
PIPEDREAM_CLIENT_SECRET=ndjulzYS7NJKcCqzIAQD9BV5W3cJpVHhvNxKnCwGDsE

# Google Gemini AI (for natural language processing)
GOOGLE_API_KEY=AIzaSyAB-nZ0o5Fdva3Ibi6f5LIxuySkNNk5Ats

# User Identifier
EXTERNAL_USER_ID=user-123
```

### How It Works:
1. **Pipedream acts as middleware** between your app and Google Calendar
2. **MCP (Model Context Protocol)** translates natural language ‚Üí API calls
3. **Gemini AI** processes the natural language requests
4. **OAuth 2.0** handles secure authentication
5. **Single calendar** (`pinkpantherking20@gmail.com`) receives all events

---

## üìù Event Format on Google Calendar

### What appears on the calendar:

```
Title: Appointment: John Doe with Dr. Sarah Johnson
Date: Tuesday, October 29, 2025
Time: 10:00 AM - 10:30 AM

Description:
Patient: John Doe
Email: john@example.com
Doctor: Dr. Sarah Johnson (Neurology - Stroke Specialist)
Reason: Stroke prevention consultation

Appointment ID: 11

Reminder: 30 minutes before
```

---

## üîÑ Data Flow Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    APPOINTMENT BOOKING                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. Save to SQLite Database (data/healthcare.db)            ‚îÇ
‚îÇ     ‚Ä¢ appointments table                                     ‚îÇ
‚îÇ     ‚Ä¢ Status: 'scheduled'                                    ‚îÇ
‚îÇ     ‚Ä¢ calendar_event_id: NULL (initially)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2. User Chooses Calendar Sync (Y/n)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ                 ‚îÇ
                 YES                NO
                   ‚îÇ                 ‚îÇ
                   ‚ñº                 ‚ñº
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ 3. CalendarSync    ‚îÇ   ‚îÇ End (DB only)‚îÇ
      ‚îÇ    Module          ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ 4. Format Natural  ‚îÇ
      ‚îÇ    Language Event  ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ 5. SmartCalendar   ‚îÇ
      ‚îÇ    Assistant       ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ 6. Pipedream MCP   ‚îÇ
      ‚îÇ    Server          ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ 7. Google Calendar ‚îÇ
      ‚îÇ    API Call        ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ 8. Event Created   ‚îÇ
      ‚îÇ    on Calendar     ‚îÇ
      ‚îÇ    pinkpantherking ‚îÇ
      ‚îÇ    20@gmail.com    ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ 9. Update DB       ‚îÇ
      ‚îÇ    calendar_event_ ‚îÇ
      ‚îÇ    id='synced'     ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ 10. Success!       ‚îÇ
      ‚îÇ     ‚úÖ Synced      ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚öôÔ∏è Key Components

### 1. **CalendarSync Module** (`modules/calendar_sync.py`)
- **Purpose**: Bridge between scheduler and calendar
- **Methods**:
  - `sync_appointment(appointment_id)` - Sync single appointment
  - `book_with_calendar()` - Book + sync in one operation
- **Features**:
  - Async support
  - Auto-retry on failure
  - Natural language formatting

### 2. **SmartCalendarAssistant** (`calendar_assistant.py`)
- **Purpose**: Interact with Google Calendar via Pipedream
- **Technology**: 
  - MCP (Model Context Protocol)
  - Gemini AI for NLP
  - Async/await pattern
- **Methods**:
  - `initialize()` - Connect to Pipedream
  - `send_message()` - Send calendar commands
  - `create_event()` - Create calendar events

### 3. **AppointmentScheduler** (`modules/scheduler.py`)
- **Purpose**: Core appointment management
- **Database**: SQLite (data/healthcare.db)
- **Features**:
  - Conflict detection
  - Availability checking
  - Doctor/patient management

---

## üéØ Current Limitations & Solutions

### **Issue 1: Single Shared Calendar**
**Current**: All doctors use `pinkpantherking20@gmail.com`

**Impact**:
- All appointments appear on same calendar
- No separation between doctors
- Harder to manage individual schedules

**Potential Solutions**:
```python
# Option A: Create separate calendars for each doctor
doctors_calendars = {
    1: 'dr.sarah.johnson@gmail.com',
    2: 'dr.michael.chen@gmail.com',
    3: 'dr.aisha.khan@gmail.com'
}

# Option B: Use color-coding on shared calendar
event_colors = {
    1: 'blue',    # Dr. Sarah Johnson
    2: 'green',   # Dr. Michael Chen
    3: 'yellow'   # Dr. Aisha Khan
}

# Option C: Add doctor name as prefix
event_title = f"[Dr. {doctor_name}] Appointment: {patient_name}"
```

### **Issue 2: No Calendar Event ID Storage**
**Current**: We store `'synced_via_assistant'` as a flag

**Impact**:
- Cannot update/delete events later
- Cannot verify sync status
- No way to handle conflicts

**Solution**:
```python
# Store actual Google Calendar event ID
# Modify calendar_sync.py to capture event ID from response
cursor.execute("""
    UPDATE appointments 
    SET calendar_event_id = ?
    WHERE appointment_id = ?
""", (actual_event_id, appointment_id))
```

---

## üîÆ Future Enhancements

### 1. **Multi-Calendar Support**
```python
class CalendarSync:
    def __init__(self, scheduler):
        self.scheduler = scheduler
        self.calendars = {
            'doctor_1': 'dr.sarah@gmail.com',
            'doctor_2': 'dr.michael@gmail.com',
            'doctor_3': 'dr.aisha@gmail.com',
            'shared': 'pinkpantherking20@gmail.com'
        }
    
    def sync_to_doctor_calendar(self, appointment_id):
        appointment = self.scheduler.get_appointment(appointment_id)
        doctor_id = appointment['doctor_id']
        
        # Get doctor-specific calendar
        calendar_email = self.get_doctor_calendar(doctor_id)
        
        # Sync to that calendar
        self.sync_to_calendar(appointment_id, calendar_email)
```

### 2. **Bidirectional Sync**
- Read events FROM Google Calendar
- Detect external changes
- Update local database
- Handle conflicts

### 3. **Event Updates & Cancellations**
```python
async def update_calendar_event(self, appointment_id):
    """Update existing calendar event when appointment changes"""
    
async def cancel_calendar_event(self, appointment_id):
    """Remove event from calendar when appointment is cancelled"""
```

### 4. **Patient Calendar Sync**
```python
# Allow patients to sync to their OWN calendars
patient_email = appointment['patient_email']
send_calendar_invite(patient_email, event_details)
```

---

## üß™ Testing the Flow

### Test Patient Booking:
```bash
python3 healthcare_assistant.py
# 1. Login as patient
# 2. Book appointment
# 3. Sync to calendar
# 4. Check pinkpantherking20@gmail.com
```

### Test Doctor View:
```bash
python3 doctor_portal.py
# 1. Login as doctor
# 2. View schedule
# 3. Bulk sync appointments
# 4. Check calendar
```

### Verify Database:
```bash
sqlite3 data/healthcare.db "
SELECT 
    a.appointment_id,
    u.name as patient,
    d.name as doctor,
    a.appointment_date,
    a.start_time,
    a.calendar_event_id,
    d.calendar_id
FROM appointments a
JOIN users u ON a.user_id = u.user_id
JOIN doctors d ON a.doctor_id = d.doctor_id
ORDER BY a.appointment_date, a.start_time;
"
```

---

## üìã Summary

### **Current Setup:**
‚úÖ **Single Calendar**: `pinkpantherking20@gmail.com`  
‚úÖ **Shared by**: All 3 doctors + all patients  
‚úÖ **Technology**: Pipedream MCP + Gemini AI  
‚úÖ **Both Portals**: Patient and Doctor can sync  
‚úÖ **Natural Language**: AI processes event creation  
‚úÖ **Database Tracked**: SQLite stores sync status  

### **How It Works:**
1. Appointment booked ‚Üí Saved to SQLite
2. User chooses sync ‚Üí CalendarSync module activated
3. Event formatted ‚Üí Natural language description
4. Sent to Pipedream ‚Üí MCP protocol translation
5. Google Calendar API ‚Üí Event created
6. Database updated ‚Üí Sync status saved
7. User notified ‚Üí Success confirmation

### **Key Files:**
- `modules/calendar_sync.py` - Calendar integration logic
- `calendar_assistant.py` - Pipedream MCP interface
- `modules/scheduler.py` - Appointment management
- `.env` - Pipedream credentials
- `data/healthcare.db` - Appointments & doctor data

---

*Last Updated: October 28, 2025*  
*Healthcare Assistant v1.0.0 - Dual Portal System*
